<title>coup::lobby</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="lobby.css">

<script type="module">
  import { html, render } from 'https://esm.sh/htm/preact'
  import { signal, computed, effect } from 'https://esm.sh/@preact/signals';
  import { Socket } from "./socket.js"

  const socket = new Socket("/lobby")
  const players = computed(() => socket.state.value?.players)
  const startingIn = computed(() => socket.state.value?.startingIn)

  socket.onError("LobbyNotFound", () => location.assign("/lobby.html"))
  socket.on("NewLobby", ({ id }) => location.replace("/lobby.html?id=" + id))

  function goToGame(gameId) {
    const lobbyId = new URLSearchParams(location.search).get("id")
    location.assign(`/game.html?id=${gameId}&lobbyId=${lobbyId}`)
  }

  socket.on("GameStarted", ({ id }) => goToGame(id))

  const Lobby = () => players.value == null ? "Loading..." : html`
    <div class="lobby">
    <h2>Players</h2>
    ${(players.value).map(player => html`
      <div class="player ${player.champion ? "champion" : ""}"><div class="player-icon" style="background-color: ${player.color}"></div>${player.name}</div>
    `)}
    ${startingIn.value === null
      ? html`<button disabled=${players.value.length <= 1} onclick=${() => socket.send("StartGame")}>Start game</button>`
      : html`<button onclick=${() => socket.send("CancelGameStart")}>Cancel</button>`
    }
    </div>
    ${startingIn.value !== null ?
      html`<p class="counter">Starting in ${startingIn.value}</p>` :
      html`<div class="new-lobby"><a href="/lobby.html?new">New lobby</a></div>`}
    `

  render(html`<${Lobby}/>`, document.body)
</script>