<title>coup::lobby</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="lobby.css">

<script type="module">
  import { html, render } from 'https://esm.sh/htm/preact'
  import { signal, computed, effect } from 'https://esm.sh/@preact/signals';
  import { Socket } from "./socket.js"

  const socket = new Socket("/lobby")
  const players = computed(() => socket.state.value?.players)
  const startingIn = computed(() => socket.state.value?.startingIn)
  const lobbyId = computed(() => socket.state.value?.id)

  effect(() => lobbyId.value != null && setLobbyId(lobbyId.value))

  socket.onError("LobbyNotFound", () => location.assign("/lobby.html"))

  function setLobbyId(id) {
    const url = new URL(location)
    const currentLobbyId = url.searchParams.get("id")
    if (id != currentLobbyId) {
      url.searchParams.set("id", id)
      location.assign(url)
    }
  }

  function gameUrl(id) {
    const url = new URL(location)
    url.pathname = "/game.html"
    url.search = ""
    url.searchParams.set("id", id)
    url.searchParams.set("lobby", lobbyId.value)
    return url
  }

  socket.on("GameStarted", ({ gameId }) => location.assign(gameUrl(gameId)))

  const Lobby = () => players.value == null ? "Loading..." : html`
    <div class="lobby">
    <h2>Players</h2>
    ${(players.value).map(player => html`
      <div class="player"><div class="player-icon" style="background-color: ${player.color}"></div>${player.name}</div>
    `)}
    ${startingIn.value === null
      ? html`<button disabled=${players.value.length <= 1} onclick=${() => socket.send("StartGame")}>Start game</button>`
      : html`<button onclick=${() => socket.send("CancelGameStart")}>Cancel</button>`
    }
    </div>
    ${startingIn.value !== null ?
      html`<p class="counter">Starting in ${startingIn.value}</p>` :
      html`<a href="/lobby.html?new">New lobby</a>`}
    `

  render(html`<${Lobby}/>`, document.body)
</script>