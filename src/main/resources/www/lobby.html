<title>coup::lobby</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="lobby.css">

<script type="importmap">
  {
    "imports": {
      "preact": "https://esm.sh/preact@10.19.2",
      "preact/": "https://esm.sh/preact@10.19.2/",
      "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact",
      "signals": "https://esm.sh/@preact/signals@1.2.1"
    }
  }
</script>

<script type="module">
  import { html, render } from "htm/preact"
  import { signal, computed } from "signals"
  import { newSocket } from "./socket.js"

  const socket = newSocket("/lobby")
  const players = computed(() => socket.state.value?.players)
  const startingIn = computed(() => socket.state.value?.startingIn)

  socket.onError("LobbyNotFound", () => location.assign("/lobby.html"))
  socket.on("GoToLobby", ({ id }) => history.replaceState({ id }, "", "/lobby.html?id=" + id))

  function goToGame(gameId) {
    const lobbyId = new URLSearchParams(location.search).get("id")
    location.assign(`/game.html?id=${gameId}&lobbyId=${lobbyId}`)
  }

  socket.on("GameStarted", ({ id }) => goToGame(id))

  const Lobby = () => players.value == null ? "Loading..." : html`
    <div class="lobby">
    <h2>Players</h2>
    ${(players.value).map(player => html`
      <div class="player ${player.champion ? "champion" : ""}"><div class="player-icon" style="background-color: ${player.color}"></div>${player.name}</div>
    `)}
    ${startingIn.value === null
      ? html`<button disabled=${players.value.length <= 1} onclick=${() => socket.send("StartGame")}>Start game</button>`
      : html`<button onclick=${() => socket.send("CancelGameStart")}>Cancel</button>`
    }
    </div>
    ${startingIn.value !== null ?
      html`<p class="counter">Starting in ${startingIn.value}</p>` :
      html`<div class="new-lobby"><a href="/lobby.html?new">New lobby</a></div>`}
    `

  render(html`<${Lobby}/>`, document.body)
</script>