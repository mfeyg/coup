<title>coup::game</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="game.css">
<link rel="stylesheet" href="player.css">
<link rel="stylesheet" href="turnIndicator.css">

<script type="module">
  import { html, render } from 'https://esm.sh/htm/preact'
  import { signal } from 'https://esm.sh/@preact/signals';
  import { Socket } from "./socket.js"
  import { Prompt } from "./prompt.js"
  import { Player } from "./player.js"
  import { TurnIndicator } from "./turnIndicator.js"

  const socket = new Socket("/game")
  const thisPlayer = signal(null)
  const players = signal([])
  const prompt = signal(null)
  const events = signal([])
  const currentTurn = signal(null)
  const loading = signal(true)

  const Game = () => loading.value ? "Loading..." : html`
  <main>
    <div class="players">
    ${players.value.map(player => player.number === thisPlayer.value?.number ? html`
      <${Player} player=${thisPlayer.value} current active=${currentTurn.value === player.number} />` : html`
      <${Player} player=${player} active=${currentTurn.value === player.number} />`)}
    </div>
    <${TurnIndicator} thisPlayer=${thisPlayer.value} activePlayer=${players.value?.[currentTurn.value]} />
    <${Prompt} prompt=${prompt.value} 
      player=${thisPlayer.value}
      opponents=${players.value}
      close=${() => prompt.value = null}/>
  </main>`

  socket.on("GameState", (game) => {
    thisPlayer.value = game.player
    players.value = game.players
    currentTurn.value = game.currentTurn
    loading.value = false
  })

  const promptTypes = [
    "TakeTurn", "RespondToAction", "RespondToChallenge",
    "RespondToBlock", "SurrenderInfluence", "Exchange",
  ]
  promptTypes.forEach(type =>
    socket.on(type, (message, respond) => prompt.value = { type, message, respond })
  )

  socket.on("Event", (event) => events.value = events.value.concat([event]))

  socket.onError("GameNotFound", () => location.assign("/lobby.html"))

  render(html`<${Game}/>`, document.body)
</script>