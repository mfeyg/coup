<title>coup::game</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="game.css">
<link rel="stylesheet" href="player.css">
<link rel="stylesheet" href="playerIsk.css">
<link rel="stylesheet" href="turnIndicator.css">

<script type="importmap">
  {
    "imports": {
      "htm/": "https://esm.sh/htm@3.1.1/",
      "preact/": "https://esm.sh/preact@10.17.1/",
      "signals": "https://esm.sh/@preact/signals@1.2.1"
    }
  }
</script>

<script type="module">
  import { html, render } from "htm/preact"
  import { signal, computed, effect } from "signals";
  import { Socket } from "./socket.js"
  import { Prompt } from "./prompt.js"
  import { Player } from "./player.js"
  import { TurnIndicator } from "./turnIndicator.js"

  const socket = new Socket("/game")
  const thisPlayer = computed(() => socket.state.value?.player)
  const players = computed(() => socket.state.value?.players)
  const currentTurn = computed(() => socket.state.value?.currentTurn)
  const prompt = signal(null)
  const winner = signal(null)

  function lobbyPath() {
    const lobbyId = new URLSearchParams(location.search).get("lobbyId")
    return lobbyId ? "/lobby.html?id=" + lobbyId : "/lobby.html"
  }

  const Game = () => !socket.state.value ? "Loading..." : html`
  <main>
    <div class="players">
    ${players.value?.map(player => player.number === thisPlayer.value?.number ? html`
      <${Player} player=${thisPlayer.value} current active=${currentTurn.value === player.number} />` : html`
      <${Player} player=${player} active=${currentTurn.value === player.number} />`)}
    </div>
    ${winner.value == null ? html`
    <${TurnIndicator} thisPlayer=${thisPlayer.value} activePlayer=${players.value?.[currentTurn.value]} /> ` :
      html`${winner.value === thisPlayer.value?.number ? html`<div class="winner">You win!</div>` : html`
    <div class="winner">${players.value[winner.value].name} wins!</div>`}
    <a href=${lobbyPath()}>Back to lobby</a>`}
    <${Prompt} prompt=${prompt.value}
      player=${thisPlayer.value}
      opponents=${players.value}
      close=${() => prompt.value = null}/>
  </main>`

  const promptTypes = [
    "TakeTurn", "RespondToAction", "RespondToChallenge",
    "RespondToBlock", "SurrenderInfluence", "Exchange",
  ]
  promptTypes.forEach(type =>
    socket.on(type, (message, respond) => prompt.value = { type, message, respond })
  )

  socket.onEvent("GameOver", e => winner.value = e.winner)

  socket.onError("GameNotFound", () => location.assign(lobbyPath()))

  render(html`<${Game}/>`, document.body)
</script>