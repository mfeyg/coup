<title>coup::game</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="game.css">

<script type="module">
  import { html, render } from 'https://esm.sh/htm/preact'
  import { signal } from 'https://esm.sh/@preact/signals';
  import { Socket } from "./socket.js"
  import { Prompt } from "./prompt.js"
  import { describe } from "./eventDescription.js"

  const socket = new Socket("/game")
  const player = signal(null)
  const players = signal([])
  const prompt = signal(null)
  const events = signal([])
  const currentTurn = signal(null)
  const loading = signal(true)

  const Game = () => loading.value ? "Loading..." : html`
  <main>
    ${player.value != null && html`<div class="player">
      <p>${player.value.name}</p>
      <p>${player.value.isk} ISK</p>
      ${player.value.revealedInfluences.length > 0 && html`<span>
        Revealed influences: <ul>${player.value.revealedInfluences.map(influence => html`<li>${influence}</li>`)}</ul></span>`}
      ${player.value.heldInfluences.length > 0 && html`<span>
        Held influences: <ul>${player.value.heldInfluences.map(influence => html`<li>${influence}</li>`)}</ul></span>`}
    </div>`}
    <div class="opponents">
    ${players.value.filter(p => p.number != player.value?.number).map(opponent => html`
      <div class="player">
        <div class="player-name">${opponent.name}</div>
        <div class="player-isk">${opponent.isk}</div>
        <div class="player-influences">
        ${[...new Array(opponent.heldInfluences)].map(() => html`<div class="player-influence player-influence-hidden"></div>`)}
        ${opponent.revealedInfluences.map(influence => html`<div class="player-influence player-influence-revealed">${influence}</div>`)}
        </div>
      </div>
    `)}
    </div>
    ${currentTurn.value === player.value?.number && html`<p><strong>It's your turn</strong></p>`}
    ${currentTurn.value !== player.value?.number && players.value[currentTurn.value] && html`<p><strong>It's ${players.value[currentTurn.value].name}'s turn</strong></p>`}
    <${Prompt} prompt=${prompt.value} 
      player=${player.value}
      opponents=${players.value}
      close=${() => prompt.value = null}/>
  </main>
  <aside>
    ${events.value.map(event => html`<p>${describe(event, players.value)}</p>`)}
  </aside>`

  socket.on("GameState", (game) => {
    player.value = game.player
    players.value = game.players
    currentTurn.value = game.currentTurn
    loading.value = false
  })

  const promptTypes = [
    "TakeTurn", "RespondToAction", "RespondToChallenge",
    "RespondToBlock", "SurrenderInfluence", "Exchange",
  ]
  promptTypes.forEach(type =>
    socket.on(type, (message, respond) => prompt.value = { type, message, respond })
  )

  socket.on("Event", (event) => events.value = events.value.concat([event]))

  render(html`<${Game}/>`, document.body)
</script>