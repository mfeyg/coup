<title>coup::game</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="game.css">

<script type="module">
  import { html, render } from 'https://esm.sh/htm/preact'
  import { signal } from 'https://esm.sh/@preact/signals';
  import { Socket } from "./socket.js"
  import { Prompt } from "./prompt.js"
  import { describe } from "./eventDescription.js"

  const socket = new Socket("/game")
  const player = signal(null)
  const players = signal([])
  const prompt = signal(null)
  const events = signal([])
  const currentTurn = signal(null)
  const loading = signal(true)

  const Game = () => loading.value ? "Loading..." : html`
  <main>
    <div class="players">
    ${players.value.map(current => current.number === player.value?.number ? html`
    <div class="player ${currentTurn.value === current.number ? "player-current" : ""}">
      <div class="player-name"><strong>You</strong></div>
      <div class="player-isk">${player.value.isk}</div>
      <div class="player-influences">
      ${player.value.heldInfluences.map(influence => html`<div class="player-influence player-influence-hidden">${influence}</div>`)}
      ${player.value.revealedInfluences.map(influence => html`<div class="player-influence player-influence-revealed">${influence}</div>`)}
      </div>
    </div>` : html`
    <div class="player ${currentTurn.value === current.number ? "player-current" : ""}">
      <div class="player-name">${current.name}</div>
      <div class="player-isk">${current.isk}</div>
      <div class="player-influences">
      ${[...new Array(current.heldInfluences)].map(() => html`<div class="player-influence player-influence-hidden"></div>`)}
      ${current.revealedInfluences.map(influence => html`<div class="player-influence player-influence-revealed">${influence}</div>`)}
      </div>
    </div>`)}
    </div>
    ${currentTurn.value === player.value?.number && html`<p><strong>It's your turn</strong></p>`}
    ${currentTurn.value !== player.value?.number && players.value[currentTurn.value] && html`<p><strong>It's ${players.value[currentTurn.value].name}'s turn</strong></p>`}
    <${Prompt} prompt=${prompt.value} 
      player=${player.value}
      opponents=${players.value}
      close=${() => prompt.value = null}/>
  </main>
  <aside>
    ${events.value.map(event => html`<p>${describe(event, players.value)}</p>`)}
  </aside>`

  socket.on("GameState", (game) => {
    player.value = game.player
    players.value = game.players
    currentTurn.value = game.currentTurn
    loading.value = false
  })

  const promptTypes = [
    "TakeTurn", "RespondToAction", "RespondToChallenge",
    "RespondToBlock", "SurrenderInfluence", "Exchange",
  ]
  promptTypes.forEach(type =>
    socket.on(type, (message, respond) => prompt.value = { type, message, respond })
  )

  socket.on("Event", (event) => events.value = events.value.concat([event]))

  render(html`<${Game}/>`, document.body)
</script>