<title>coup::game</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="game.css">
<link rel="stylesheet" href="player.css">
<link rel="stylesheet" href="playerIsk.css">
<link rel="stylesheet" href="turnIndicator.css">

<script type="module">
  import { html, render } from 'https://esm.sh/htm/preact'
  import { signal, computed } from 'https://esm.sh/@preact/signals';
  import { Socket } from "./socket.js"
  import { Prompt } from "./prompt.js"
  import { Player } from "./player.js"
  import { TurnIndicator } from "./turnIndicator.js"

  const socket = new Socket("/game")
  const thisPlayer = computed(() => socket.state.value?.player)
  const players = computed(() => socket.state.value?.players)
  const currentTurn = computed(() => socket.state.value?.currentTurn)
  const prompt = signal(null)
  const winner = signal(null)

  const Game = () => !socket.state.value ? "Loading..." : html`
  <main>
    <div class="players">
    ${players.value?.map(player => player.number === thisPlayer.value?.number ? html`
      <${Player} player=${thisPlayer.value} current active=${currentTurn.value === player.number} />` : html`
      <${Player} player=${player} active=${currentTurn.value === player.number} />`)}
    </div>
    <${TurnIndicator} thisPlayer=${thisPlayer.value} activePlayer=${players.value?.[currentTurn.value]} />
    ${winner.value && html`<div class="winner">${winner.value} wins!</div>`}
    <${Prompt} prompt=${prompt.value} 
      player=${thisPlayer.value}
      opponents=${players.value}
      close=${() => prompt.value = null}/>
  </main>`

  const promptTypes = [
    "TakeTurn", "RespondToAction", "RespondToChallenge",
    "RespondToBlock", "SurrenderInfluence", "Exchange",
  ]
  promptTypes.forEach(type =>
    socket.on(type, (message, respond) => prompt.value = { type, message, respond })
  )

  socket.onEvent("GameOver", e => winner.value = e.winner)

  socket.onError("GameNotFound", () => location.assign("/lobby.html"))

  render(html`<${Game}/>`, document.body)
</script>