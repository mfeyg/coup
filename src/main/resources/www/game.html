<title>coup::game</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="game.css">
<link rel="stylesheet" href="player.css">
<link rel="stylesheet" href="playerIsk.css">
<link rel="stylesheet" href="turnIndicator.css">

<script type="importmap">
  {
    "imports": {
      "htm/": "https://esm.sh/htm@3.1.1/",
      "preact/": "https://esm.sh/preact@10.17.1/",
      "signals": "https://esm.sh/@preact/signals@1.2.1"
    }
  }
</script>

<script type="module">
  import { html, render } from "htm/preact"
  import { signal, computed } from "signals"
  import { Socket } from "./socket.js"
  import { Prompt } from "./prompt.js"
  import { Player } from "./player.js"
  import { TurnIndicator } from "./turnIndicator.js"

  const socket = new Socket("/game")
  const thisPlayer = computed(() => socket.state.value?.player)
  const players = computed(() => socket.state.value?.players)
  const currentTurn = computed(() => socket.state.value?.currentTurn)
  const prompt = signal(null)
  const winner = signal(null)

  function lobbyPath() {
    const lobbyId = new URLSearchParams(location.search).get("lobbyId")
    return lobbyId ? "/lobby.html?id=" + lobbyId : "/lobby.html"
  }

  function Loading() {
    return html`<div class="loading-indicator">Loading...</div>`
  }

  function Players({players, thisPlayer, currentTurn}) {
    if (!players) return null;
    return html`<div class="players"> ${players.map(player => {
      let current = false
      let active = currentTurn == player.number
      if (player.number === thisPlayer?.number) {
        player = thisPlayer
        current = true
      }
      return html`${Player} player=${player} current=${current} active=${active} />`
    })}</div>`;
  }

  function WinnerIndicator({winner, thisPlayer, players}) {
    if (winner == null) return null
    let message
    if (winner == thisPlayer?.number) {
      message = html`<div class="winner">You win!</div>`
    } else {
      message = html`<div class="winner">${players[winner].name} wins!</div>`
    }
    return html`
      ${message}
      <a href=${lobbyPath()}>Back to lobby</a>
    `
  }

  const Game = () => !socket.state.value ? html`<${Loading} />` : html`
  <main>
    <${Players} players=${players.value} thisPlayer=${thisPlayer.value} currentTurn=${currentTurn.value} />
    <${WinnerIndicator} winner=${winner.value} thisPlayer=${thisPlayer.value} players=${players.value} />
    <${TurnIndicator} thisPlayer=${thisPlayer.value} activePlayer=${players.value?.[currentTurn.value]} /> 
    <${Prompt} prompt=${prompt.value}
      player=${thisPlayer.value}
      opponents=${players.value}
      close=${() => prompt.value = null}/>
  </main>`

  const promptTypes = [
    "TakeTurn", "RespondToAction", "RespondToChallenge",
    "RespondToBlock", "SurrenderInfluence", "Exchange",
  ]
  promptTypes.forEach(type =>
    socket.on(type, (message, respond) => prompt.value = { type, message, respond })
  )

  socket.onEvent("GameOver", e => winner.value = e.winner)

  socket.onError("GameNotFound", () => location.assign(lobbyPath()))

  render(html`<${Game}/>`, document.body)
</script>